# 攻击事件架构重构计划

## 1. 项目概述

### 1.1 目标
重构现有的事件系统，将攻击逻辑和特效逻辑完全分离，建立清晰的事件驱动架构，提升系统的可维护性、可扩展性和可测试性。

### 1.2 背景
当前 `EventTrigger.Attack` 方法存在职责混乱问题：
- 既处理游戏逻辑（攻击行为）又处理视觉反馈（特效）
- 攻击逻辑和特效逻辑耦合严重
- 缺乏专门的攻击事件，无法独立监听攻击行为
- 伤害数字系统只能通过特效事件触发，逻辑不清晰

### 1.3 预期收益
- **职责清晰**：攻击逻辑和特效逻辑完全分离
- **松耦合**：各系统独立运行，互不影响
- **易扩展**：新增攻击相关功能只需添加监听器
- **可维护**：修改攻击逻辑不影响特效，反之亦然
- **可测试**：可以独立测试各个系统
- **性能优化**：只有需要特效的攻击才触发特效事件

## 2. 架构设计

### 2.1 事件职责分离

#### 2.1.1 AttackEvent（游戏逻辑事件）
**职责：**
- 攻击行为定义
- 伤害计算和传递
- 游戏状态变化
- 攻击相关数据记录

**监听者：**
- 伤害数字系统
- 血量系统
- AI系统
- 统计系统
- 成就系统
- 音效系统

**核心参数：**
- 攻击类型（Hit, Shoot, Skill, Magic等）
- 攻击位置和方向
- 攻击者和目标对象
- 伤害值和伤害类型
- 暴击率和暴击伤害
- 攻击时间戳

#### 2.1.2 EffectEvent（视觉反馈事件）
**职责：**
- 视觉特效播放
- 音效播放
- 震动反馈
- 粒子效果
- 屏幕震动

**监听者：**
- 特效系统
- 音效系统
- 震动系统
- 粒子系统

**核心参数：**
- 特效类型
- 特效位置和方向
- 特效强度
- 目标对象和标签
- 特效持续时间

### 2.2 事件关联机制

#### 2.2.1 事件链式触发
采用事件链式触发模式，确保攻击逻辑和特效逻辑的关联性：

```
游戏逻辑 → AttackEvent → [多个监听器]
                        ├── EffectManager → EffectEvent → 特效播放
                        ├── DamageTextManager → 伤害数字显示
                        ├── HealthSystem → 血量扣除
                        ├── AISystem → AI反应
                        └── SoundManager → 音效播放
```

#### 2.2.2 监听器职责
- **EffectManager**：监听 AttackEvent，根据攻击类型触发对应的 EffectEvent
- **DamageTextManager**：监听 AttackEvent，当伤害值大于0时显示伤害数字
- **HealthSystem**：监听 AttackEvent，处理血量扣除和死亡逻辑
- **AISystem**：监听 AttackEvent，处理AI对攻击的反应
- **SoundManager**：监听 AttackEvent，播放攻击相关音效

### 2.3 数据流设计

#### 2.3.1 攻击数据流
```
攻击计算 → AttackEvent → 游戏逻辑处理 → 状态更新
```

#### 2.3.2 特效数据流
```
AttackEvent → EffectManager → EffectEvent → 视觉反馈
```

#### 2.3.3 伤害数字数据流
```
AttackEvent → DamageTextManager → 伤害数字显示
```

## 3. 实施计划

### 3.1 阶段一：事件结构定义
**目标：** 创建 AttackEvent 结构体和相关基础设施

**任务：**
1. 在 `GameEvents.cs` 中添加 `AttackEvent` 结构体
2. 定义 AttackEvent 的触发方法
3. 设计 AttackEvent 的参数结构
4. 确保与现有 MMEventManager 兼容

**交付物：**
- AttackEvent 结构体定义
- AttackEvent.Trigger 方法
- 事件参数验证机制

### 3.2 阶段二：EventTrigger 重构
**目标：** 简化 EventTrigger.Attack 方法，只负责触发攻击事件

**任务：**
1. 修改 `EventTrigger.Attack` 方法
2. 移除特效相关逻辑
3. 确保向后兼容性
4. 添加参数验证

**交付物：**
- 重构后的 EventTrigger.Attack 方法
- 向后兼容性保证
- 参数验证机制

### 3.3 阶段三：EffectManager 监听器实现
**目标：** 实现 EffectManager 对 AttackEvent 的监听和响应

**任务：**
1. 修改 EffectManager 添加 AttackEvent 监听
2. 实现攻击类型到特效类型的映射
3. 处理特效事件的触发逻辑
4. 确保特效播放的正确性

**交付物：**
- EffectManager 监听器实现
- 攻击类型映射表
- 特效触发逻辑

### 3.4 阶段四：DamageTextManager 重构
**目标：** 修改 DamageTextManager 监听 AttackEvent 而不是 EffectEvent

**任务：**
1. 修改 DamageTextManager 监听 AttackEvent
2. 实现伤害值提取逻辑
3. 确保伤害数字显示的正确性
4. 优化性能

**交付物：**
- 重构后的 DamageTextManager
- 伤害值提取逻辑
- 性能优化方案

### 3.5 阶段五：其他系统集成
**目标：** 集成其他需要监听攻击事件的系统

**任务：**
1. 识别需要监听攻击事件的系统
2. 实现各系统的 AttackEvent 监听器
3. 测试系统间的协作
4. 性能优化

**交付物：**
- 各系统的监听器实现
- 系统集成测试报告
- 性能优化报告

### 3.6 阶段六：测试和优化
**目标：** 全面测试新架构，确保稳定性和性能

**任务：**
1. 单元测试各个事件监听器
2. 集成测试整个攻击流程
3. 性能测试和优化
4. 回归测试确保现有功能正常

**交付物：**
- 完整的测试套件
- 性能测试报告
- 回归测试报告
- 优化建议

## 4. 技术规范

### 4.1 命名规范
- **事件结构体**：`AttackEvent`, `EffectEvent`, `GameStateEvent`
- **触发方法**：`AttackEvent.Trigger()`, `EffectEvent.Trigger()`
- **监听器方法**：`OnMMEvent(AttackEvent attackEvent)`

### 4.2 参数规范
- **攻击类型**：使用字符串常量，如 "Hit", "Shoot", "Skill"
- **伤害值**：使用 float 类型，支持小数
- **位置参数**：使用 Vector3 类型
- **对象引用**：使用 GameObject 类型

### 4.3 错误处理
- 参数验证：在事件触发前验证必要参数
- 异常处理：使用 try-catch 包装关键逻辑
- 日志记录：记录关键操作和错误信息

### 4.4 性能要求
- **事件触发延迟**：< 1ms
- **内存占用**：最小化事件对象的内存分配
- **GC压力**：避免频繁的垃圾回收

## 5. 风险评估

### 5.1 技术风险
- **兼容性风险**：现有代码可能依赖旧的事件结构
- **性能风险**：事件链式触发可能增加延迟
- **调试风险**：事件链式触发可能增加调试难度

### 5.2 缓解措施
- **渐进式迁移**：保持旧接口的同时添加新接口
- **性能监控**：添加性能监控点，及时发现性能问题
- **调试工具**：开发事件调试工具，方便问题定位

### 5.3 回滚计划
- 保留旧的事件结构
- 提供配置开关，可以快速切换回旧架构
- 准备详细的回滚步骤文档

## 6. 验收标准

### 6.1 功能验收
- [ ] AttackEvent 可以正确触发和监听
- [ ] 特效系统可以正确响应攻击事件
- [ ] 伤害数字系统可以正确显示
- [ ] 现有攻击功能完全正常
- [ ] 新架构性能不低于旧架构

### 6.2 代码质量验收
- [ ] 代码符合项目编码规范
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过率 100%
- [ ] 代码审查通过

### 6.3 文档验收
- [ ] 架构设计文档完整
- [ ] API 文档更新
- [ ] 迁移指南完整
- [ ] 故障排除指南完整

## 7. 时间计划

### 7.1 总体时间
- **预计总工期**：2-3 周
- **开发时间**：1.5-2 周
- **测试时间**：0.5-1 周

### 7.2 里程碑
- **第1周**：完成阶段一、二、三
- **第2周**：完成阶段四、五
- **第3周**：完成阶段六和文档

### 7.3 关键路径
- AttackEvent 结构体定义 → EventTrigger 重构 → EffectManager 监听器 → 系统集成测试

## 8. 后续规划

### 8.1 短期优化
- 性能监控和优化
- 调试工具开发
- 文档完善

### 8.2 长期扩展
- 支持更复杂的攻击类型
- 添加攻击链和连击系统
- 集成更丰富的视觉反馈

### 8.3 技术债务
- 清理旧的事件结构
- 统一事件命名规范
- 优化事件监听器性能
