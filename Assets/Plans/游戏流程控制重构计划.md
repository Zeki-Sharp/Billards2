# 游戏流程控制重构计划

## 📋 项目概述

本计划旨在重构现有的台球游戏流程控制系统，将其改造为基于幸存者游戏框架的轻量级流程控制，并集成独特的能量系统和时停机制，提高代码的可维护性和游戏体验。

## 🎯 重构目标

### 主要目标
1. **简化流程控制** - 从复杂的阶段管理转向轻量级状态机
2. **集成能量系统** - 实现基于能量恢复的时停蓄力机制
3. **优化敌人管理** - 采用幸存者游戏框架的敌人行为模式
4. **保持现有功能** - 在重构过程中保持现有特效和UI系统
5. **提升游戏体验** - 创造更流畅和紧张的游戏节奏

### 设计原则
- **轻量级架构** - 基于幸存者游戏框架的简化设计
- **事件驱动** - 继续使用MMEventManager进行组件通信
- **模块化设计** - 能量系统、时停系统独立可配置
- **向后兼容** - 保持现有脚本资产的基本功能

## 🏗️ 目标架构设计

### 整体架构图
```
游戏流程控制系统 (基于幸存者游戏框架)
├── GameFlowController (游戏流程总控制器)
│   ├── 职责：整体流程协调，状态管理
│   ├── 管理：游戏状态切换、全局事件分发
│   └── 状态：Normal (正常游戏) / Charging (蓄力时停)
│
├── EnergySystem (能量系统)
│   ├── 职责：能量恢复、蓄力管理、状态切换触发
│   ├── 功能：自动恢复、阈值检查、蓄力进度
│   └── 事件：能量就绪、能量耗尽、蓄力进度更新
│
├── TimeStopManager (时停管理器)
│   ├── 职责：时停效果控制、时间缩放管理
│   ├── 功能：全局时停、对象时间缩放、效果恢复
│   └── 影响：敌人、子弹、粒子系统等
│
├── EnemyManager (敌人管理器)
│   ├── 职责：敌人生成、AI行为、时停适配
│   ├── 功能：定期生成、朝玩家移动、行为更新
│   └── 优化：基于幸存者游戏框架的轻量级管理
│
└── EventSystem (事件系统 - 保持现有)
    ├── 继续使用 MMEventManager 作为核心
    ├── 保持现有的事件类型和触发机制
    └── 添加能量和时停相关的新事件类型
```

### 游戏流程重新设计

#### 当前流程 (台球模式)
```
玩家阶段 → 微调阶段 → 敌人阶段
```

#### 目标流程 (幸存者模式 + 能量时停 + 三状态设计)
```
正常游戏状态 (Normal)
├── 玩家持续移动躲避
├── 敌人执行移动+射击循环
├── 子弹正常飞行和碰撞
├── 能量自动恢复
└── 能量满时允许蓄力

蓄力时停状态 (Charging)
├── 完全时停 (敌人、子弹静止)
├── 玩家瞄准和蓄力
├── 蓄力进度可视化
└── 发射后进入过渡状态

过渡状态 (Transition)
├── 玩家可以移动
├── 敌人仍然时停
├── 白球运动进行
├── 子弹仍然时停
└── 一段时间后回到正常游戏状态
```

#### 核心机制说明
- **能量恢复**：在正常状态下自动缓慢恢复
- **状态切换**：能量达到阈值 + 玩家长按左键
- **时停效果**：蓄力和过渡阶段时停，但玩家运动状态不同
- **敌人行为**：简化的移动+射击循环，每次移动一步后射击一次
- **循环机制**：发射后消耗能量，经过过渡状态回到正常状态

## 🔧 核心组件设计

### 1. GameFlowController (游戏流程总控制器)

**职责**：整体流程协调，三状态管理
- **状态管理**：Normal (正常游戏) / Charging (蓄力时停) / Transition (过渡状态)
- **组件协调**：管理能量系统、时停管理器、敌人管理器、过渡管理器
- **事件分发**：处理全局游戏事件和状态切换
- **输入处理**：检测蓄力输入和状态切换条件

**核心功能**：
- 检测能量系统状态和玩家输入
- 控制游戏状态在三个状态之间切换
- 协调各个子系统的启动和停止
- 处理游戏开始、暂停、结束等全局状态
- 管理过渡状态的特殊逻辑

### 2. EnergySystem (能量系统)

**职责**：能量恢复、蓄力管理、状态切换触发
- **能量恢复**：在正常状态下自动缓慢恢复能量
- **阈值检查**：检测能量是否达到发射阈值
- **蓄力管理**：管理蓄力进度和最大蓄力时间
- **状态通知**：通过事件通知其他系统能量状态变化

**核心功能**：
- 自动能量恢复机制
- 能量阈值检测和状态切换触发
- 蓄力进度计算和可视化支持
- 能量消耗和重置机制

### 3. TimeStopManager (时停管理器)

**职责**：时停效果控制、时间缩放管理
- **全局时停**：控制Time.timeScale实现时停效果
- **对象管理**：管理受时停影响的对象（敌人、子弹等）
- **效果恢复**：时停结束后恢复所有对象的时间缩放
- **性能优化**：只影响必要的对象，避免不必要的计算

**核心功能**：
- 全局时间缩放控制
- 敌人和子弹的时停适配
- 粒子系统和特效的时停处理
- 时停状态的开始和结束管理

### 4. EnemyManager (敌人管理器)

**职责**：敌人生成、简化AI行为、时停适配
- **敌人生成**：基于幸存者游戏框架的定期生成机制
- **简化AI**：敌人执行移动+射击循环的基本行为
- **时停适配**：确保敌人在时停状态下正确响应
- **性能优化**：轻量级的管理方式，适合大量敌人

**核心功能**：
- 定期敌人生成和数量控制
- 简化的移动+射击循环AI
- 敌人生命值管理和死亡处理
- 时停状态下的行为暂停和恢复
- 子弹生成和飞行管理

### 5. TransitionManager (过渡状态管理器)

**职责**：过渡状态管理、部分时停控制
- **过渡控制**：管理从蓄力状态到正常状态的过渡
- **部分时停**：保持敌人和子弹时停，允许玩家移动
- **状态监控**：监控白球运动完成状态
- **自动切换**：一段时间后自动切换到正常状态

**核心功能**：
- 管理过渡状态的开始和结束
- 控制部分时停效果（敌人静止，玩家可移动）
- 监控白球运动状态和攻击完成
- 处理过渡超时保护机制

### 6. EventSystem (事件系统 - 保持现有)

**职责**：统一的事件通信机制
- **继续使用MMEventManager**：保持现有的事件系统架构
- **事件类型扩展**：添加能量和时停相关的新事件类型
- **向后兼容**：保持现有脚本的事件监听和触发机制
- **性能优化**：利用MMEventManager的高性能特性

**核心功能**：
- 保持现有的AttackEvent、EffectEvent等事件类型
- 添加EnergyEvent、TimeStopEvent等新事件类型
- 维持现有的事件触发和监听机制
- 支持新系统的松耦合通信需求

## 📝 实施计划

### 阶段1：核心系统重构

#### 1.1 游戏流程控制器重构
- **目标**：将现有GameManager重构为轻量级GameFlowController
- **任务**：
  - 实现三状态管理：Normal、Charging、Transition
  - 移除复杂的阶段转换逻辑
  - 集成能量系统、时停管理器和过渡管理器
  - 保持与现有脚本的兼容性

#### 1.2 能量系统实现
- **目标**：实现基于能量恢复的时停蓄力机制
- **任务**：
  - 创建EnergySystem组件
  - 实现自动能量恢复机制
  - 实现能量阈值检测和状态切换触发
  - 实现蓄力进度管理和可视化支持
  - 集成到现有的事件系统中

#### 1.3 时停管理器实现
- **目标**：实现时停效果控制和时间缩放管理
- **任务**：
  - 创建TimeStopManager组件
  - 实现全局时间缩放控制
  - 实现敌人和子弹的时停适配
  - 实现粒子系统和特效的时停处理
  - 优化时停状态的性能影响

#### 1.4 过渡状态管理器实现
- **目标**：实现过渡状态的特殊管理逻辑
- **任务**：
  - 创建TransitionManager组件
  - 实现部分时停效果控制
  - 实现白球运动状态监控
  - 实现过渡超时保护机制
  - 集成到游戏流程控制器中

### 阶段2：敌人系统重构

#### 2.1 敌人管理器重构
- **目标**：将现有EnemyController重构为简化的EnemyManager
- **任务**：
  - 实现简化的移动+射击循环AI
  - 实现定期敌人生成和数量控制
  - 实现敌人生命值管理和死亡处理
  - 实现子弹生成和飞行管理
  - 适配时停状态下的行为暂停和恢复

#### 2.2 敌人行为优化
- **目标**：优化敌人行为管理，提高性能
- **任务**：
  - 实现简化的移动+射击循环AI
  - 优化大量敌人时的性能表现
  - 确保时停状态下的正确行为
  - 实现子弹生成和飞行管理

### 阶段3：现有系统集成

#### 3.1 特效系统集成
- **目标**：确保现有特效系统与新流程兼容
- **任务**：
  - 保持现有EffectManager和EffectPlayer功能
  - 添加时停状态下的特效处理
  - 确保能量系统相关特效正常工作
  - 优化特效在时停状态下的表现

#### 3.2 UI系统适配
- **目标**：适配现有UI系统到新的游戏流程
- **任务**：
  - 保持现有UI控制器功能
  - 添加能量条和蓄力进度显示
  - 适配时停状态下的UI更新
  - 确保游戏状态显示正确

#### 3.3 物理系统适配
- **目标**：确保现有物理系统与时停机制兼容
- **任务**：
  - 保持现有BallPhysics和碰撞检测功能
  - 适配时停状态下的物理计算
  - 确保白球发射机制正常工作
  - 优化物理对象的时间缩放处理

### 阶段4：测试与优化

#### 4.1 功能测试
- **目标**：确保新流程功能完整且稳定
- **任务**：
  - 测试能量恢复和蓄力机制
  - 测试时停效果的正确性
  - 测试敌人行为在时停状态下的表现
  - 测试完整游戏流程的稳定性

#### 4.2 性能优化
- **目标**：优化新系统的性能表现
- **任务**：
  - 优化时停状态下的性能影响
  - 优化大量敌人时的性能表现
  - 优化能量系统的计算效率
  - 确保整体游戏流畅度

#### 4.3 平衡性调整
- **目标**：调整游戏平衡性，确保良好的游戏体验
- **任务**：
  - 调整能量恢复速度
  - 调整敌人生成频率和强度
  - 调整蓄力时间和威力
  - 测试不同难度下的游戏体验

## 🚀 技术实现细节

### 状态机设计
**简化的三状态设计**：
- **Normal**：正常游戏状态，玩家移动躲避，敌人执行移动+射击循环，能量自动恢复
- **Charging**：蓄力时停状态，完全时停，玩家瞄准蓄力，敌人和子弹静止
- **Transition**：过渡状态，玩家可移动，敌人和子弹仍时停，白球运动进行

### 事件系统设计
**基于现有MMEventManager的扩展**：
- **保持现有事件**：AttackEvent、EffectEvent、DeathEvent等
- **新增能量事件**：EnergyEvent（能量恢复、能量就绪、能量耗尽）
- **新增时停事件**：TimeStopEvent（时停开始、时停结束、部分时停）
- **新增游戏状态事件**：GameStateEvent（状态切换、蓄力进度、过渡状态）
- **新增敌人行为事件**：EnemyBehaviorEvent（移动开始、射击开始、行为完成）

### 配置系统设计
**模块化配置管理**：
- **能量系统配置**：恢复速度、阈值、蓄力时间等
- **时停系统配置**：时间缩放、影响对象、效果持续时间等
- **敌人系统配置**：生成频率、移动距离、射击冷却、最大数量等
- **过渡系统配置**：过渡超时时间、部分时停控制等
- **游戏平衡配置**：难度曲线、平衡性参数等

### 性能优化策略
**轻量级架构优化**：
- **时停优化**：只影响必要的对象，避免全局计算
- **敌人管理优化**：简化的移动+射击循环，计算开销小
- **过渡状态优化**：部分时停效果，减少不必要的计算
- **事件系统优化**：利用MMEventManager的高性能特性
- **内存管理优化**：子弹对象池化、敌人资源复用等

## ⚠️ 风险评估与缓解

### 技术风险
1. **三状态切换复杂性** - 三个状态之间的切换逻辑可能复杂
   - *缓解*：使用清晰的状态机设计，确保状态切换的可靠性
   
2. **部分时停实现难度** - 过渡状态的部分时停效果实现复杂
   - *缓解*：使用精确的对象管理，确保时停效果的准确性
   
3. **敌人行为同步** - 简化的移动+射击循环可能影响游戏节奏
   - *缓解*：仔细调整移动距离和射击冷却时间，确保游戏平衡

### 业务风险
1. **游戏体验变化** - 从台球模式到幸存者模式可能影响用户体验
   - *缓解*：保持核心游戏机制，逐步调整游戏平衡
   
2. **现有功能兼容** - 重构可能影响现有特效和UI系统
   - *缓解*：保持现有系统架构，只添加必要的适配代码

## 📊 成功指标

### 功能指标
- [ ] 能量系统正常工作，恢复和消耗机制稳定
- [ ] 三状态切换流畅，时停效果正确
- [ ] 敌人移动+射击循环流畅，AI表现符合预期
- [ ] 过渡状态部分时停效果正确
- [ ] 现有特效和UI系统正常工作

### 性能指标
- [ ] 三状态切换延迟低，响应迅速
- [ ] 时停状态下帧率保持稳定
- [ ] 大量敌人和子弹时性能表现良好
- [ ] 能量系统计算效率高
- [ ] 整体游戏流畅度良好

### 用户体验指标
- [ ] 游戏节奏紧张刺激，三状态切换自然
- [ ] 能量蓄力机制直观易懂
- [ ] 时停效果视觉反馈清晰
- [ ] 敌人移动+射击循环节奏感好
- [ ] 整体游戏体验流畅

## 📚 相关文档

- [游戏阶段系统重构计划.md](./游戏阶段系统重构计划.md)
- [阶段管理系统使用说明.md](./阶段管理系统使用说明.md)
- [EventSystem_Refactoring_Plan.md](./EventSystem_Refactoring_Plan.md)

## 🔄 版本历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 1.0 | 2024-01-XX | AI Assistant | 初始版本，整体架构设计 |
| 2.0 | 2024-01-XX | AI Assistant | 基于新游戏规则重构，简化架构设计 |
| 2.1 | 2024-01-XX | AI Assistant | 基于三状态设计和简化敌人行为更新 |

---

**注意**：本计划基于新的游戏规则（幸存者模式 + 能量时停机制 + 三状态设计）进行了重大调整，从复杂的阶段管理转向轻量级的状态机设计。敌人行为简化为移动+射击循环，增加了过渡状态管理。在实施过程中需要特别注意与现有脚本资产的兼容性。
