# 阶段管理系统使用说明

## 概述

按照重构计划，游戏现在采用了新的阶段管理系统，将原来的混乱状态管理重构为清晰的模块化架构。

## 核心组件

### 1. GameManager (总协调器)
- **职责**: 管理整体游戏流程，协调玩家和敌人阶段转换
- **特殊功能**: 直接管理微调阶段（需要检查所有物体停止状态）
- **单例模式**: 通过 `GameManager.Instance` 访问

### 2. PlayerController (玩家阶段管理器)
- **职责**: 管理玩家的蓄力和运动阶段
- **包含功能**: 瞄准、蓄力、发射、瞄准线绘制
- **阶段**: Aim（蓄力）、Dash（运动）

### 3. EnemyController (敌人阶段管理器)
- **职责**: 管理敌人的三个阶段
- **阶段**: Attack（攻击）、Move（移动）、Telegraph（预攻击）

### 4. WhiteBall (白球实体)
- **简化**: 移除了微调相关逻辑，专注于物理行为
- **事件**: 发出 `OnBallStopped` 事件通知停止

## 阶段流程

```
玩家蓄力阶段 → 白球运动阶段 → 白球微调阶段 → 敌人攻击阶段 → 敌人移动阶段 → 敌人预攻击阶段 → 回到玩家蓄力阶段
```

## 使用方法

### 1. 场景设置
1. 在场景中创建一个空的GameObject，命名为"GameManager"
2. 添加 `GameManager` 脚本
3. 创建另一个空GameObject，命名为"PlayerController"
4. 添加 `PlayerController` 脚本
5. 创建第三个空GameObject，命名为"EnemyController"
6. 添加 `EnemyController` 脚本

### 2. 白球设置
1. 确保白球有 `WhiteBall` 脚本
2. 设置适当的物理参数
3. 确保白球有正确的标签（"Player"）

### 3. 敌人设置
1. 确保敌人有 `Enemy` 脚本
2. 设置适当的物理参数
3. 确保敌人有正确的标签（"Enemy"）

### 4. UI设置（可选）
1. 创建UI文本显示游戏状态
2. 添加 `TestPhaseSystem` 脚本进行调试

## 关键特性

### 微调阶段特殊处理
- 微调阶段由 `GameManager` 直接管理
- 需要等待所有白球和敌人都停止运动才能开始
- 倒计时3秒后自动进入敌人回合

### 事件系统
- 各组件通过事件进行通信
- 松耦合设计，易于扩展

### 状态管理
- 清晰的状态转换逻辑
- 每个阶段都有明确的职责

## 调试

### 日志输出
- 每个阶段转换都有详细的日志输出
- 可以通过 `TestPhaseSystem` 脚本查看实时状态

### 常见问题
1. **白球无法发射**: 检查是否在正确的阶段（Aim阶段）
2. **阶段不转换**: 检查事件订阅是否正确
3. **微调阶段不开始**: 检查所有物体是否都停止了运动

## 扩展性

### 添加新功能
1. **新玩家能力**: 在 `PlayerController` 中添加
2. **新敌人类型**: 在 `EnemyController` 中管理
3. **新游戏状态**: 在 `GameManager` 中添加

### 自定义阶段
- 可以通过继承和重写方法来自定义阶段行为
- 事件系统支持灵活的功能扩展

## 注意事项

1. **单例模式**: `GameManager` 使用单例模式，确保场景中只有一个实例
2. **事件清理**: 在 `OnDestroy` 中正确取消事件订阅
3. **状态同步**: 确保所有组件都正确订阅了相关事件

这个新的阶段管理系统解决了之前的状态管理混乱问题，提供了清晰的架构和良好的扩展性。
